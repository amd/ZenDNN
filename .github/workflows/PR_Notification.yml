# ******************************************************************************
# Copyright (c) 2025 Advanced Micro Devices, Inc.
# All rights reserved.
# ******************************************************************************
name: PR Status Notification
on:
  check_suite:
    types: [completed]

permissions:
  checks: read
  pull-requests: read
  contents: read
  actions: read

jobs:
  notify_teams:
    runs-on: amd-zenai-arc-xsmall-dind
    # Only run if there's a PR associated with the check suite
    if: github.event.check_suite.pull_requests[0]
    
    steps:
      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.check_suite.pull_requests[0];
            if (!pr) return { number: null };
            
            return {
              number: pr.number,
              title: pr.title || '',
              url: pr.html_url || '',
              head_sha: pr.head.sha,
              author: pr.user?.login || '',
              base_ref: pr.base?.ref || '',
              head_ref: pr.head?.ref || ''
            };

      - name: Wait and check if all workflows are complete
        id: workflow_status
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse(`\${{ steps.pr_info.outputs.result }}`);
            if (!pr.number) return { all_complete: false };
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = pr.head_sha;
            
            // Function to check workflow status
            const checkWorkflowStatus = async () => {
              // Get all workflow runs for this commit
              const workflowResp = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha: ref,
                per_page: 100
              });
              
              const workflows = workflowResp.data.workflow_runs || [];
              
              // Filter out notification workflows
              const relevantWorkflows = workflows.filter(run => 
                !run.name.includes('PR Status Notification') &&
                !run.name.includes('notification')
              );

              // Get check runs
              const checkResp = await github.rest.checks.listForRef({
                owner,
                repo,
                ref,
                per_page: 100
              });
              const checks = checkResp.data.check_runs || [];
              
              // Filter out notification checks
              const relevantChecks = checks.filter(check => 
                !check.name.includes('PR Status Notification') &&
                !check.name.includes('notification')
              );

              // Check if any are still running
              const runningWorkflows = relevantWorkflows.filter(w => 
                ['in_progress', 'queued', 'pending', 'waiting'].includes(w.status)
              );
              
              const runningChecks = relevantChecks.filter(c => 
                ['in_progress', 'queued', 'pending', 'waiting'].includes(c.status)
              );

              const allComplete = runningWorkflows.length === 0 && runningChecks.length === 0;
              
              return {
                all_complete: allComplete,
                workflows: relevantWorkflows,
                checks: relevantChecks,
                running_workflows: runningWorkflows.length,
                running_checks: runningChecks.length
              };
            };

            // Initial check
            let result = await checkWorkflowStatus();
            
            // If not all complete, wait and check again (up to 5 minutes)
            let attempts = 0;
            const maxAttempts = 30; // 30 attempts * 10 seconds = 5 minutes
            
            while (!result.all_complete && attempts < maxAttempts) {
              console.log(`Attempt ${attempts + 1}: ${result.running_workflows} workflows and ${result.running_checks} checks still running. Waiting...`);
              await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              result = await checkWorkflowStatus();
              attempts++;
            }

            if (!result.all_complete) {
              console.log(`Timeout reached. Some workflows/checks may still be running.`);
            }

            return result;

      - name: Get final workflow results
        id: final_results
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse(`\${{ steps.pr_info.outputs.result }}`);
            const workflowStatus = JSON.parse(`\${{ steps.workflow_status.outputs.result }}`);
            
            if (!pr.number) return { workflows: [], status: 'unknown' };
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = pr.head_sha;

            // Get fresh data for final results
            const workflowResp = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              head_sha: ref,
              per_page: 100
            });
            
            const workflows = workflowResp.data.workflow_runs || [];
            
            const checkResp = await github.rest.checks.listForRef({
              owner,
              repo,
              ref,
              per_page: 100
            });
            const checks = checkResp.data.check_runs || [];

            // Combine workflow and check information
            const allRuns = [];
            
            // Add workflow runs
            workflows
              .filter(run => 
                !run.name.includes('PR Status Notification') &&
                !run.name.includes('notification')
              )
              .forEach(run => {
                allRuns.push({
                  id: run.id,
                  name: run.name,
                  status: run.conclusion || run.status,
                  url: run.html_url,
                  type: 'workflow_run',
                  repository: `${owner}/${repo}`,
                  created_at: run.created_at,
                  completed_at: run.updated_at
                });
              });

            // Add check runs that aren't already covered by workflow runs
            checks
              .filter(check => 
                !check.name.includes('PR Status Notification') &&
                !check.name.includes('notification') &&
                !allRuns.find(run => run.name === check.name)
              )
              .forEach(check => {
                allRuns.push({
                  id: check.id,
                  name: check.name,
                  status: check.conclusion || check.status,
                  url: check.html_url,
                  type: 'check_run',
                  repository: check.repository?.full_name || `${owner}/${repo}`,
                  created_at: check.started_at,
                  completed_at: check.completed_at
                });
              });

            // Sort by completion time
            allRuns.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

            // Calculate final status
            const failed = allRuns.filter(r => r.status === 'failure');
            const cancelled = allRuns.filter(r => r.status === 'cancelled');
            const success = allRuns.filter(r => r.status === 'success');
            const skipped = allRuns.filter(r => r.status === 'skipped');
            const stillRunning = allRuns.filter(r => 
              ['in_progress', 'queued', 'pending', 'waiting'].includes(r.status)
            );

            let finalStatus = 'success';
            if (failed.length > 0) {
              finalStatus = 'failure';
            } else if (cancelled.length > 0) {
              finalStatus = 'cancelled';
            } else if (stillRunning.length > 0) {
              finalStatus = 'in_progress';
            }

            // Create detailed results
            const failures = failed.map(r => `âŒ ${r.name}: Failed`);
            const successes = success.map(r => `âœ… ${r.name}: Passed`);

            return {
              workflows: allRuns,
              status: finalStatus,
              failures: failures,
              successes: successes,
              summary: {
                total: allRuns.length,
                success: success.length,
                failed: failed.length,
                cancelled: cancelled.length,
                skipped: skipped.length,
                still_running: stillRunning.length
              },
              all_complete: stillRunning.length === 0
            };

      - name: Send Final Status Teams Notification
        env:
          ZENDNNL_WEBHOOK_URL: ${{ secrets.ZENDNNL_WEBHOOK_URL }}
        run: |
          # Get JSON outputs
          pr_json='${{ steps.pr_info.outputs.result }}'
          results_json='${{ steps.final_results.outputs.result }}'

          PR_NUMBER=$(echo "$pr_json" | jq -r '.number // "N/A"')
          PR_TITLE=$(echo "$pr_json" | jq -r '.title // "N/A"' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          PR_URL=$(echo "$pr_json" | jq -r '.url // "N/A"')
          PR_AUTHOR=$(echo "$pr_json" | jq -r '.author // "N/A"')
          HEAD_SHA=$(echo "$pr_json" | jq -r '.head_sha // "N/A"')
          SHORT_SHA=$(echo "$HEAD_SHA" | cut -c1-7)

          STATUS=$(echo "$results_json" | jq -r '.status // "unknown"')
          TOTAL_WORKFLOWS=$(echo "$results_json" | jq -r '.summary.total // 0')
          SUCCESS_COUNT=$(echo "$results_json" | jq -r '.summary.success // 0')
          FAILED_COUNT=$(echo "$results_json" | jq -r '.summary.failed // 0')
          CANCELLED_COUNT=$(echo "$results_json" | jq -r '.summary.cancelled // 0')
          STILL_RUNNING_COUNT=$(echo "$results_json" | jq -r '.summary.still_running // 0')
          ALL_COMPLETE=$(echo "$results_json" | jq -r '.all_complete // false')

          # Get workflow list with final status
          WORKFLOW_LIST=$(echo "$results_json" | jq -r '.workflows[] | "â€¢ [\(.name)](\(.url)) - **\(.status | ascii_upcase)**"')
          
          # Get success and failure summaries
          SUCCESS_LIST=$(echo "$results_json" | jq -r '.successes[]?' 2>/dev/null | head -5)
          FAILURE_LIST=$(echo "$results_json" | jq -r '.failures[]?' 2>/dev/null | head -5)

          # Set final status display
          if [ "$STATUS" = "success" ]; then
            ICON="ðŸŸ¢"
            STATUS_TEXT="âœ… ALL CHECKS PASSED"
            COLOR="Good"
          elif [ "$STATUS" = "failure" ]; then
            ICON="ðŸ”´"
            STATUS_TEXT="âŒ SOME CHECKS FAILED"
            COLOR="Attention"
          elif [ "$STATUS" = "cancelled" ]; then
            ICON="ðŸŸ "
            STATUS_TEXT="ðŸŸ  SOME CHECKS CANCELLED"
            COLOR="Warning"
          else
            ICON="ðŸŸ¡"
            STATUS_TEXT="ðŸŸ¡ CHECKS INCOMPLETE"
            COLOR="Warning"
          fi

          # Add completion status
          if [ "$ALL_COMPLETE" = "true" ]; then
            COMPLETION_TEXT="ðŸ All workflows completed"
          else
            COMPLETION_TEXT="â³ $STILL_RUNNING_COUNT workflows still running"
          fi

          # Escape for JSON
          TITLE_SAFE="$ICON  PR #$PR_NUMBER â€” $PR_TITLE"
          WORKFLOW_LIST_SAFE=$(echo "$WORKFLOW_LIST" | sed 's/"/\\"/g')
          SUCCESS_LIST_SAFE=$(echo "$SUCCESS_LIST" | sed 's/"/\\"/g')
          FAILURE_LIST_SAFE=$(echo "$FAILURE_LIST" | sed 's/"/\\"/g')

          # Create final status notification
          cat > card.json <<EOF
          {
            "type": "message",
            "attachments": [
              {
                 "contentType": "application/vnd.microsoft.card.adaptive",
                 "content": {
                    "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.4",
                    "body": [
                      {
                         "type": "Container",
                         "items": [
                           {
                              "type": "TextBlock",
                              "text": "$TITLE_SAFE",
                              "wrap": true,
                              "weight": "Bolder",
                              "size": "Medium"
                           },
                           {
                              "type": "TextBlock",
                              "text": "$STATUS_TEXT",
                              "wrap": true,
                              "weight": "Bolder",
                              "color": "$COLOR",
                              "size": "Large"
                           },
                           {
                              "type": "FactSet",
                              "facts": [
                                 { "title": "Author:", "value": "$PR_AUTHOR" },
                                 { "title": "Commit:", "value": "$SHORT_SHA" },
                                 { "title": "Completion:", "value": "$COMPLETION_TEXT" },
                                 { "title": "Total Workflows:", "value": "$TOTAL_WORKFLOWS" },
                                 { "title": "âœ… Passed:", "value": "$SUCCESS_COUNT" },
                                 { "title": "âŒ Failed:", "value": "$FAILED_COUNT" },
                                 { "title": "ðŸŸ  Cancelled:", "value": "$CANCELLED_COUNT" }
                               ]
                              },
                              {
                                 "type": "TextBlock",
                                 "text": "**All Workflow Results:**\\n$WORKFLOW_LIST_SAFE",
                                 "wrap": true,
                                 "size": "Small"
                              }
                            ]
                          }
                        ],
                        "actions": [
                          {
                             "type": "Action.OpenUrl",
                             "title": "View PR",
                             "url": "$PR_URL"
                          },
                          {
                             "type": "Action.OpenUrl",
                             "title": "View All Checks",
                             "url": "https://github.com/${{ github.repository }}/pull/$PR_NUMBER/checks"
                          },
                          {
                              "type": "Action.OpenUrl",
                              "title": "View Commit",
                              "url": "https://github.com/${{ github.repository }}/commit/$HEAD_SHA"
                          }
                       ]
                   }
              }
             ]
          }
          EOF

          curl -s -H "Content-Type: application/json" \
            -d @card.json \
            "$ZENDNNL_WEBHOOK_URL" || (echo "Failed to send Teams message" && exit 1)

          echo "Final status notification sent for PR #$PR_NUMBER: $STATUS_TEXT"
