# ******************************************************************************
# Copyright (c) 2025 Advanced Micro Devices, Inc.
# All rights reserved.
# ******************************************************************************
name: PR Status Notification
on:
  pull_request:
    types: [opened, reopened, synchronize]
  check_suite:
    types: [completed]


permissions:
  checks: read
  pull-requests: read
  contents: read

jobs:
  notify_teams:
    runs-on: amd-zenai-arc-xsmall-dind
    steps:


      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const ev = context.payload;
            let pr = null;
            if (context.eventName === 'check_suite') {
              pr = ev.check_suite?.pull_requests?.[0];
              if (!pr) return { number: null };
            } else {
              pr = ev.pull_request;
            }
             // Get the workflow run URL
             const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            return {
              number: pr.number,
              title: pr.title || '',
              url: pr.html_url || '',
              head_sha: pr.head_sha || (pr.head && pr.head.sha) || null,
              author: pr.user?.login || '',
              run_url: runUrl,
              commit_sha: pr.head_sha || (pr.head && pr.head.sha) || context.sha,
              commit_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${pr.head_sha || (pr.head && pr.head.sha) || context.sha}`
            };

      - name: Get failed check (if any) and status
        id: check_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse(`\${{ steps.pr_info.outputs.result }}`);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref =
              pr.head_sha ||
              context.payload.check_suite?.head_sha ||
              context.payload.pull_request?.head?.sha;
            if (!ref) {
              return { status: 'unknown', failures: ["No commit SHA found"] };
            }

            // list check runs for the commit (paginated if necessary)
            const resp = await github.rest.checks.listForRef({
              owner,
              repo,
              ref,
              per_page: 100
            });
            const runs = resp.data.check_runs || [];

            // Collect all failures
            const failures = runs
              .filter(r => r.conclusion === 'failure')
              .map(r => `âŒ ${r.name}: ${(r.output?.summary || r.output?.title || "").substr(0,200)}`);

            const cancelled = runs.some(r => r.conclusion === 'cancelled');

            return {
              status: failures.length > 0 ? 'failure' :
                      cancelled ? 'cancelled' :
                      'success',
              failures: failures
            };

      - name: Send Adaptive Card to Teams
        env:
          ZENDNNL_WEBHOOK_URL: ${{ secrets.ZENDNNL_WEBHOOK_URL }}
        run: |
          # get JSON outputs from previous steps
          pr_json='${{ steps.pr_info.outputs.result }}'
          check_json='${{ steps.check_info.outputs.result }}'

          PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
          PR_TITLE=$(echo "$pr_json" | jq -r '.title' | sed "s/'/\\'/g" | sed 's/"/\\"/g')
          PR_URL=$(echo "$pr_json" | jq -r '.url')
          PR_AUTHOR=$(echo "$pr_json" | jq -r '.author')
          RUN_URL=$(echo "$pr_json" | jq -r '.run_url')
          COMMIT_SHA=$(echo "$pr_json" | jq -r '.commit_sha')
          COMMIT_URL=$(echo "$pr_json" | jq -r '.commit_url')
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
          
          STATUS=$(echo "$check_json" | jq -r '.status')
          FAILURE_LIST=$(echo "$check_json" | jq -r '.failures[]?')
          if [ "$STATUS" = "failure" ]; then
            FAIL_TEXT=$(printf "%s\n" $FAILURE_LIST | sed 's/"/\\"/g')
          else
            FAIL_TEXT="No failures"
          fi


          if [ "$STATUS" = "success" ]; then
            COLOR="#22C55E"
            ICON="ðŸŸ¢"
            STATUS_TEXT="Success"
          elif [ "$STATUS" = "failure" ]; then
            COLOR="#EF4444"
            ICON="ðŸ”´"
            STATUS_TEXT="Failure"
          elif [ "$STATUS" = "cancelled" ]; then
            COLOR="#F59E0B"
            ICON="ðŸŸ "
            STATUS_TEXT="Cancelled"
          else
            COLOR="#6B7280"
            ICON="âšª"
            STATUS_TEXT="Unknown"
          fi
          # Properly escape content for JSON
          PR_TITLE_SAFE=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g')
          FAIL_TEXT_SAFE=$(echo "$FAIL_TEXT" | sed 's/\\/\\\\/g')
          # build adaptive card JSON (simple and compatible)
          cat > card.json <<EOF
          {
            "type": "message",
            "attachments": [
              {
                 "contentType": "application/vnd.microsoft.card.adaptive",
                 "content": {
                    "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.4",
                    "body": [
                      {
                         "type": "Container",
                         "items": [
                           {
                              "type": "TextBlock",
                              "text": "$ICON  PR #$PR_NUMBER â€” $PR_TITLE",
                              "wrap": true,
                              "weight": "Bolder",
                              "size": "Medium"
                           },
                           {
                              "type": "FactSet",
                              "facts": [
                                  { "title": "Status:", "value": "$STATUS_TEXT" },
                                  { "title": "Author:", "value": "$PR_AUTHOR" },
                                  { "title": "Commit:", "value": "$SHORT_SHA" },
                                  { "title": "Workflow Run:", "value": "[View Actions Run]($RUN_URL)" }
                               ]
                              },
                              {
                                "type": "TextBlock",
                                "text": "**Failure Details:**\n$FAIL_TEXT",
                                "wrap": true,
                                "color": "Attention"
                              }
                            ]
                          }
                        ],
                        "actions": [
                          {
                             "type": "Action.OpenUrl",
                             "title": "Open Pull Request",
                             "url": "$PR_URL"
                          },
                          {
                             "type": "Action.OpenUrl",
                             "title": "View Actions Run",
                             "url": "$RUN_URL"
                          },
                          {
                             "type": "Action.OpenUrl",
                             "title": "View Commit",
                             "url": "$COMMIT_URL"
                          }
                       ]
                   }
              }
             ]
          }
          EOF

          curl -s -H "Content-Type: application/json" \
            -d @card.json \
            "$ZENDNNL_WEBHOOK_URL" || (echo "Failed to send Teams message" && exit 1)

          echo "Teams notification sent successfully"
